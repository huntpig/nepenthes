#include <stdio.h>
#include <stdlib.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include <unistd.h>
#include <netdb.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/select.h>
#include <ctype.h>

#define HOSTNAME "130.75.181.9"
#define PORT 445


unsigned char ntscan_req1[]={
0x00,0x00,0x00,0x85,0xff,0x53,0x4d,0x42,0x72,0x00,0x00,0x00,0x00,0x18,0x53,0xc8
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xfe
,0x00,0x00,0x00,0x00,0x00,0x62,0x00,0x02,0x50,0x43,0x20,0x4e,0x45,0x54,0x57,0x4f
,0x52,0x4b,0x20,0x50,0x52,0x4f,0x47,0x52,0x41,0x4d,0x20,0x31,0x2e,0x30,0x00,0x02
,0x4c,0x41,0x4e,0x4d,0x41,0x4e,0x31,0x2e,0x30,0x00,0x02,0x57,0x69,0x6e,0x64,0x6f
,0x77,0x73,0x20,0x66,0x6f,0x72,0x20,0x57,0x6f,0x72,0x6b,0x67,0x72,0x6f,0x75,0x70
,0x73,0x20,0x33,0x2e,0x31,0x61,0x00,0x02,0x4c,0x4d,0x31,0x2e,0x32,0x58,0x30,0x30
,0x32,0x00,0x02,0x4c,0x41,0x4e,0x4d,0x41,0x4e,0x32,0x2e,0x31,0x00,0x02,0x4e,0x54
,0x20,0x4c,0x4d,0x20,0x30,0x2e,0x31,0x32,0x00};

unsigned char ntscan_req2[]={

};


typedef unsigned int uint;
typedef unsigned char byte;

void hexdump(byte *data, uint len)
{
	char conv[] = "0123456789abcdef";

	printf("=------------------[ hexdump(0x%08x , 0x%08x) ]-------------------=\n", (unsigned int)data, len);
	for( unsigned int i = 0; i < len; i += 0x10 )
	{
		printf("0x%04x  ", i);

		for( unsigned int j = 0; j < 0x10; j++ )
		{
			if( i + j < len )
			{
				printf("%c%c ",conv[((data[i + j] & 0xFF) >> 4)],conv[((data[i + j] & 0xff) & 0x0F)]);
			}
			else
				printf("   ");

			if( j == 7 )
				printf(" ");
		}

		printf(" ");

		for( unsigned int j = 0; j < 0x10; j++ )
		{
			if( i + j < len )
				printf("%c", isprint(data[i + j]) ? data[i + j] : '.');
			else
				printf(" ");
			if( j == 7 )
				printf(" ");
		}

		printf("\n");
	}
	printf("=-------------------------------------------------------------------------=\n");
}


char *getreply(int sockfd,int timeout)
{
	printf("[*] Trying to receive a reply \n");

	char rb[1500];
	fd_set  fdreadme;
	int i;
	struct timeval tv;
	tv.tv_sec = 1;
	tv.tv_usec = 0;

	FD_ZERO(&fdreadme);
	FD_SET(sockfd, &fdreadme);

	FD_SET(sockfd, &fdreadme);
	FD_SET(0, &fdreadme);
	if(select(FD_SETSIZE, &fdreadme, NULL, NULL, &tv) < 0 ) 
	{
		return NULL;
	}
	if(FD_ISSET(sockfd, &fdreadme)) 
	{
		if((i = recv(sockfd, rb, sizeof(rb), 0)) < 0)
		{
			printf("[-] Connection lost..\n");
			exit(1);
		}else
		{
			printf("\t[+] got %i bytes of data \n",i);
			hexdump((byte *)rb,i);
		}
	}
	return NULL;
}


int senddata(int sockfd,unsigned char *data,int len)
{
	int sended=0;
	if ( (sended = send(sockfd,data,len,0)) != len )
	{
		printf("\t[-] Could not send complete data (%i < %i)\n",sended,len);
	} else
	{
		printf("\t[+] Sended Request \n");
	}
	return sended;
}

int main()
{
	struct hostent *he;
	struct sockaddr_in their_addr;
	int sockfd=-1;	
	
	printf("[*]Resolving Hostname %s \n",HOSTNAME);
	if((he = gethostbyname(HOSTNAME)) == NULL)
        {
        	printf("\t[-] gethostbyname: Couldnt resolve hostname\n");
                exit(1);
        }
        printf("\t[+] Done. (%s) \n", inet_ntoa(*((struct in_addr *)he->h_addr)));

        printf("[*] Connecting Server \n");
        
    	their_addr.sin_family = AF_INET;
    	their_addr.sin_addr = *((struct in_addr *)he->h_addr);
    	their_addr.sin_port = htons(PORT);

	if ((sockfd=socket(AF_INET,SOCK_STREAM,0)) == -1)
	{
		perror("\t[-] Socket failed");
		return(0);
	} else
	{
		printf("\t[+] created Socket \n");
	}
    
	if ( connect(sockfd,(struct sockaddr *)&their_addr, sizeof(struct sockaddr)) == -1 )
	{
		perror("\t[-] Connect failed");
		return(0);
	} else
	{
		printf("\t[+] Connected ...\n");
	}
	
	printf("[*] Sending Request #1 (%i bytes)\n",sizeof(ntscan_req1));

	senddata(sockfd,ntscan_req1,sizeof(ntscan_req1));
	getreply(sockfd,0);

	printf("[*] Sending Request #2 (%i bytes)\n",sizeof(ntscan_req1));

	senddata(sockfd,ntscan_req2,sizeof(ntscan_req1));
	getreply(sockfd,0);


	printf("[*] Closing Socket \n");
		printf("\t[+] done (%i)\n",close(sockfd));
	
	return 0;
}
